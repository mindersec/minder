"use strict";(self.webpackChunkminder_docs=self.webpackChunkminder_docs||[]).push([[4223],{93537:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>h});const i=JSON.parse('{"id":"how-to/custom-rules","title":"Writing custom rule types","description":"Minder\'s policy engine is flexible enough that you can write your own rule types","source":"@site/docs/how-to/custom-rules.md","sourceDirName":"how-to","slug":"/how-to/custom-rules","permalink":"/how-to/custom-rules","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":100,"frontMatter":{"title":"Writing custom rule types","sidebar_position":100},"sidebar":"minder","previous":{"title":"Creating a new project","permalink":"/how-to/create_project"},"next":{"title":"Writing rules using Rego","permalink":"/how-to/writing-rules-in-rego"}}');var o=t(74848),s=t(28453);const r={title:"Writing custom rule types",sidebar_position:100},a=void 0,l={},h=[{value:"Minder policies",id:"minder-policies",level:2},{value:"Rule types",id:"rule-types",level:2},{value:"Example: Automatically delete head branches",id:"example-automatically-delete-head-branches",level:2},{value:"Ingestion / evaluation",id:"ingestion--evaluation",level:3},{value:"Alerting",id:"alerting",level:3},{value:"Remediation",id:"remediation",level:3},{value:"Description &amp; guidance",id:"description--guidance",level:3},{value:"Trying the rule out",id:"trying-the-rule-out",level:2},{value:"Conclusion",id:"conclusion",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.p,{children:"Minder's policy engine is flexible enough that you can write your own rule types\nto check for specific settings in your supply chain. This guide will walk you\nthrough the process of writing a custom rule type."}),"\n",(0,o.jsx)(n.h2,{id:"minder-policies",children:"Minder policies"}),"\n",(0,o.jsx)(n.p,{children:"Minder allows you to check and enforce that certain settings are set up for\nseveral stages in your supply chain. To configure those settings, you need to\ncreate a profile. This profile is composed of several rules that represent the\nsettings you want in your supply chain. These rules are actually instantiations\nof another handy object for Minder called rule types. These rule types define\nthe nitty-gritty details of how the specific setting you care about will be\nchecked, how you'll be alerted when something goes out of order, and how it will\nbe automatically remediated."}),"\n",(0,o.jsxs)(n.p,{children:["You can browse a curated collection of rule types in the\n",(0,o.jsx)(n.a,{href:"https://github.com/mindersec/minder-rules-and-profiles",children:"rules and profiles repository"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"Some of the rules include:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Verifying if you have GitHub's secret scanning enabled"}),"\n",(0,o.jsx)(n.li,{children:"Verifying if your artifacts are signed and verifiable on Sigstore"}),"\n",(0,o.jsx)(n.li,{children:"Verifying that your branch protection settings are secure"}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"rule-types",children:"Rule types"}),"\n",(0,o.jsx)(n.p,{children:"Rule types aren't particularly complicated. They include the basic structure to\nget an observed state, evaluate the rule based on that observed state, do\nactions based on that state, and finally, give you some instructions in case you\nwant to manage things manually."}),"\n",(0,o.jsx)(n.p,{children:"The Rule type object in YAML looks as follows:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"---\nversion: v1\ntype: rule-type\nname: my_cool_new_rule\ndescription: // Description goes here\nguidance: // Guidance goes here\ndef:\n  in_entity: repository  // what are we evaluating?\n  param_schema: // parameters go here\n  rule_schema: // rule definition schema goes here\n  # Defines the configuration for ingesting data relevant for the rule\n  ingest: // observed state gets fetched here\n  eval: // evaluation goes here\n  remediation: // fixing the issue goes here\n  alert: // alerting goes here\n"})}),"\n",(0,o.jsx)(n.p,{children:"The following are the components of a rule type:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"description"}),": What does the rule do? This is handy to browse through rule\ntypes when building a profile."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"guidance"}),": What do I do if this rule presents a \u201cfailure\u201d? This is handy to\ninform folks of what to do in case they're not using automated remediations."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"in_entity"}),": What are we evaluating? This defines the entity that's being\nevaluated. It could be repository, artifact, pull_request, and\nbuild_environment (coming soon)."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"param_schema"}),": Optional fields to pass to the ingestion (more on this\nlater). This is handy if we need extra data to get the observed state of an\nentity."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"rule_schema"}),": Optional fields to pass to the evaluation (more on this\nlater). This is handy for customizing how a rule is evaluated."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"ingest"}),": This step defines how we get the observed state for an entity. It\ncould be a simple REST call, a cloning of a git repo, or even a custom action\nif it's a complex rule."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"eval"}),": This is the evaluation stage, which defines the actual rule\nevaluation."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"remediation"}),": How do we fix the issue? This defines the action to be taken\nwhen we need to fix an issue. This is what happens when you enable automated\nremediations."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"alert"}),": How do we notify folks about the issue? This may take the form of a\nGitHub Security Advisory, but we'll support more alerting systems in the near\nfuture."]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"example-automatically-delete-head-branches",children:"Example: Automatically delete head branches"}),"\n",(0,o.jsx)(n.p,{children:"Let's write a rule type for checking that GitHub automatically deletes branches\nafter a pull request has been merged. While this is not strictly a security\nsetting, it is a good practice to keep your branches clean to avoid confusion."}),"\n",(0,o.jsx)(n.h3,{id:"ingestion--evaluation",children:"Ingestion / evaluation"}),"\n",(0,o.jsx)(n.p,{children:"The first thing we need to figure out is how to get the observed state of what\nwe want to evaluate on. This is the ingestion part."}),"\n",(0,o.jsxs)(n.p,{children:["Fortunately for us, GitHub keeps up-to-date and extensive documentation on their\nAPIs. A quick internet search leads us to the relevant\n",(0,o.jsx)(n.a,{href:"https://docs.github.com/en/rest/repos/repos?apiVersion=2022-11-28#get-a-repository",children:"Repositories API"}),"\nwhere we can see that a call to the ",(0,o.jsx)(n.code,{children:"/repos/OWNER/REPO"})," endpoint gives us the\nfollowing key: ",(0,o.jsx)(n.code,{children:"delete_branch_on_merge"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"So, by now we know that we may fetch this information via a simple REST call."}),"\n",(0,o.jsx)(n.p,{children:"The ingestion piece would then look as follows:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'---\ndef:\n  ...\n  ingest:\n    type: rest\n    rest:\n      endpoint: "/repos/{{.Entity.Owner}}/{{.Entity.Name}}"\n      parse: json\n'})}),"\n",(0,o.jsxs)(n.p,{children:["While you could hard-code the user/org and name of the repository you want to\nevaluate, that kind of rule is not handy, especially if you want to enroll\nmultiple repositories in Minder. Thus, Minder has a templating system that\nallows you to base multiple parts of the rule type on the entity you're\nevaluating (remember the in_entity part of the rule type?). The fields you may\nuse are part of the entity's protobuf, which can be found in\n",(0,o.jsx)(n.a,{href:"https://minder-docs.stacklok.dev/ref/proto#repository",children:"our documentation"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["Now, we want to tell Minder what to actually evaluate from that state. This is\nthe evaluation step. In our case, we want to verify that delete_branch_on_merge\nis set to true. For our intent, we have a very simple evaluation driver that\nwill do the trick just fine! That is the\n",(0,o.jsx)(n.a,{href:"https://jqlang.github.io/jq/",children:"jq evaluation type"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"I understand this is not a setting that everybody would want, and, in fact, some\nfolks might want that setting to be off. This is something we can achieve with a\nsimple toggle. To do it, we need to add a rule_schema to our rule, which would\nallow us to have a configurable setting in our rule."}),"\n",(0,o.jsx)(n.p,{children:"The evaluation would look as follows:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"---\ndef:\n  rule_schema:\n    type: object\n    properties:\n      enabled:\n        type: boolean\n    required:\n      - enabled\n  eval:\n    type: jq\n    jq:\n      - ingested:\n          def: '.delete_branch_on_merge'\n        profile:\n          def: '.enabled'\n"})}),"\n",(0,o.jsx)(n.p,{children:"The rule type above now allows us to compare the delete_branch_on_merge setting\nwe got from the GitHub call, and evaluate it against the enabled setting we've\nregistered for our rule type."}),"\n",(0,o.jsx)(n.h3,{id:"alerting",children:"Alerting"}),"\n",(0,o.jsx)(n.p,{children:"We'll now describe how you may get a notification if your repository doesn't\nadhere to the rule. This is as simple as adding the following to the manifest:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"---\ndef:\n  alert:\n    type: security_advisory\n    security_advisory:\n      severity: 'low'\n"})}),"\n",(0,o.jsx)(n.p,{children:"This will create a security advisory in your GitHub repository that you'll be\nable to browse for information. Minder knows already what information to fill-in\nto make the alert relevant."}),"\n",(0,o.jsx)(n.h3,{id:"remediation",children:"Remediation"}),"\n",(0,o.jsx)(n.p,{children:"Minder has the ability to auto-fix issues that it finds in your supply chain,\nlet's add an automated fix to this rule! Similarly to ingestion, remediations\nalso have several flavors or types. For our case, a simple REST remediation\nsuffices."}),"\n",(0,o.jsx)(n.p,{children:"Let's see how it would look:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"---\ndef:\n  remediate:\n    type: rest\n    rest:\n      method: PATCH\n      endpoint: '/repos/{{.Entity.Owner}}/{{.Entity.Name}}'\n      body: |\n        { \"delete_branch_on_merge\": {{ .Profile.enabled }} }\n"})}),"\n",(0,o.jsxs)(n.p,{children:["This effectively would do a PATCH REST call to the GitHub API if it finds that\nthe rule is out of compliance. We're able to parametrize the call with whatever\nwe defined in the profile using golang templates (that's the\n",(0,o.jsx)(n.code,{children:"{{ .Profile.enabled }}"})," section you see in the message's body)."]}),"\n",(0,o.jsx)(n.h3,{id:"description--guidance",children:"Description & guidance"}),"\n",(0,o.jsx)(n.p,{children:"There are a couple of sections that allow us to give information to rule type\nusers about the rule and what to do with it. These are the description and\nguidance. The description is simply a textual representation of what the rule\ntype should do. Guidance is the text that will show up if the rule fails.\nGuidance is relevant when automatic remediations are not enabled, and we want to\ngive folks instructions on what to do to fix the issue."}),"\n",(0,o.jsx)(n.p,{children:"For our rule, they will look as follows:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'---\nversion: v1\ntype: rule-type\nname: my_cool_new_rule\ncontext:\n  provider: github\ndescription: |\n  This rule verifies that branches are deleted automatically once a pull\n  request merges.\nguidance: |\n  To manage whether branches should be automatically deleted for your repository\n  you need to toggle the "Automatically delete head branches" setting in the\n  general configuration of your repository.\n\n  For more information, see the GitHub documentation on the topic: https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/configuring-pull-request-merges/managing-the-automatic-deletion-of-branches\n'})}),"\n",(0,o.jsx)(n.h2,{id:"trying-the-rule-out",children:"Trying the rule out"}),"\n",(0,o.jsxs)(n.p,{children:["The whole rule can be seen in the\n",(0,o.jsx)(n.a,{href:"https://github.com/mindersec/minder-rules-and-profiles",children:"rules and profiles GitHub repository"}),".\nIn order to try it out, we'll use the minder CLI, which points to the Minder\nserver hosted by your friends at Stacklok."]}),"\n",(0,o.jsx)(n.p,{children:"Before continuing, make sure you use our Quickstart to install the CLI and\nenroll your GitHub repos."}),"\n",(0,o.jsx)(n.p,{children:"Let's create the rule:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"minder ruletype create -f rules/github/automatic_branch_deletion.yaml\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Here, you can already see how the description gets displayed. This same\ndescription will be handy when browsing rules through ",(0,o.jsx)(n.code,{children:"minder ruletype list"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"Let's now try it out! We can call our rule in a profile as follows:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"---\nversion: v1\ntype: profile\nname: degustation-profile\ncontext:\n  provider: github\nalert: 'on'\nremediate: 'off'\nrepository:\n  - type: automatic_branch_deletion\n    def:\n      enabled: true\n"})}),"\n",(0,o.jsx)(n.p,{children:"We'll call this degustation-profile.yaml. Let's create it!"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"minder profile create -f degustation-profile.yaml\n"})}),"\n",(0,o.jsx)(n.p,{children:"Now, let's view the status of the profile:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"minder profile status list -n degustation-profile -d\n"})}),"\n",(0,o.jsx)(n.p,{children:"Depending on how your repository is set up, you may see a failure or a success.\nIf you see a failure, you can enable automated remediations and see how Minder\nfixes the issue for you."}),"\n",(0,o.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,o.jsx)(n.p,{children:"We've now created a basic new rule for Minder. There are more ingestion types,\nrule evaluation engines, and remediation types that we can use today, and there\nwill be more in the future! If you need support writing your own rule types,\nfeel free to reach out to the Minder team."})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var i=t(96540);const o={},s=i.createContext(o);function r(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);