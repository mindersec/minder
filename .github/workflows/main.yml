#
# Copyright 2023 Stacklok, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Main
on:
  push:
    branches:
      - main
      - release-*
    paths-ignore:
      - "**.md"
      - "doc/**"
      - "**.txt"
      - "images/**"
      - "LICENSE"
  pull_request:
    branches:
      - main
      - release-*
    paths-ignore:
      - "**.md"
      - "doc/**"
      - "**.txt"
      - "images/**"
      - "LICENSE"

permissions:
  contents: read

jobs:
  golangci:
    name: golangci-lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3 # v3.5.0
      - name: deps
        run: sudo apt-get update && sudo apt-get install -yq libpcsclite-dev
      - name: Extract version of Go to use
        run: echo "GOVERSION=$(sed -n 's/^go \([0-9.]*\)/\1/p' go.mod)" >> $GITHUB_ENV
      - uses: actions/setup-go@v4 # v4.0.0
        with:
          go-version: ${{ env.GOVERSION }}
      - name: golangci-lint
        uses: golangci/golangci-lint-action@08e2f20817b15149a52b5b3ebe7de50aff2ba8c5 # v3.4.0
        timeout-minutes: 5
        with:
          # Required: the version of golangci-lint is required and must be specified without patch version: we always use the latest patch version.
          version: v1.51.0

  license-check:
    uses: ./.github/workflows/reusable-jobs/license-check.yml
  golangci-lint:
    uses: ./.github/workflows/reusable-jobs/golangci-lint.yml
  build:
    uses: ./.github/workflows/reusable-jobs/build.yml
  test:
    uses: ./.github/workflows/reusable-jobs/test.yml
